<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - La Catrina Pool League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            padding-top: 2rem;
        }

        h1 {
            color: #d4af37;
            font-size: 36px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #aaa;
        }

        .section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            color: #d4af37;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            margin-right: 12px;
            margin-bottom: 12px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .leaderboard-container {
            margin-top: 20px;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-item.champion {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rank {
            font-weight: bold;
            color: #d4af37;
            min-width: 30px;
        }

        .wins {
            color: #4ade80;
            font-weight: bold;
        }

        .status {
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 16px;
        }

        .status.success {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid #4ade80;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }

        .status.info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
        }

        .period-select {
            margin-bottom: 16px;
        }

        .period-select label {
            display: block;
            margin-bottom: 8px;
            color: #d4af37;
        }

        .period-select select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="position: absolute; top: 2rem; right: 2rem; display: flex; align-items: center; gap: 15px;">
                <div id="langSelectorContainer"></div>
                <div id="notificationBellContainer"></div>
            </div>
            <h1 data-i18n="admin_title">Panel de Administraci√≥n</h1>
            <p class="subtitle" data-i18n="admin_subtitle">Sistema de Campeones - La Catrina Pool League</p>
        </header>

        <div class="section">
            <div class="section-title" data-i18n="admin_calculate_champions">üèÜ Calcular y Otorgar Campeones</div>
            <p style="color: #aaa; margin-bottom: 16px;" data-i18n="admin_champions_desc">
                Estos botones calculan los campeones del per√≠odo anterior y otorgan los badges correspondientes.
            </p>
            
            <button class="btn" onclick="awardChampions('daily')" data-i18n="admin_champion_daily">Campe√≥n del D√≠a (Ayer)</button>
            <button class="btn" onclick="awardChampions('weekly')" data-i18n="admin_champion_weekly">Campe√≥n de la Semana (Semana Pasada)</button>
            <button class="btn" onclick="awardChampions('monthly')" data-i18n="admin_champion_monthly">Campe√≥n del Mes (Mes Pasado)</button>
            <button class="btn" onclick="awardChampions('quarterly')" data-i18n="admin_champion_quarterly">Campe√≥n del Trimestre (Trimestre Pasado)</button>
            <button class="btn" onclick="awardChampions('yearly')" data-i18n="admin_champion_yearly">Campe√≥n del A√±o (A√±o Pasado)</button>
            
            <div id="awardStatus"></div>
        </div>

        <div class="section">
            <div class="section-title" data-i18n="admin_add_match">‚ûï A√±adir Partido Manualmente</div>
            <p style="color: #aaa; margin-bottom: 16px;">
                A√±ade partidos manualmente sin l√≠mites. Sistema admin.
            </p>
            
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <label style="color: #d4af37; margin-bottom: 8px; display: block;">Jugador 1:</label>
                    <select id="player1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff;">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                
                <div style="flex: 1; min-width: 250px;">
                    <label style="color: #d4af37; margin-bottom: 8px; display: block;">Jugador 2:</label>
                    <select id="player2" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff;">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 16px;">
                <div style="flex: 1; min-width: 250px;">
                    <label style="color: #d4af37; margin-bottom: 8px; display: block;">Ganador:</label>
                    <select id="winner" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff;">
                        <option value="">Seleccionar ganador...</option>
                    </select>
                </div>
                
                <div style="flex: 1; min-width: 250px;">
                    <label style="color: #d4af37; margin-bottom: 8px; display: block;">Tipo de Partido:</label>
                    <select id="matchType" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff;">
                        <option value="rey_mesa">Rey de la Mesa (√ó1.0)</option>
                        <option value="torneo">Torneo (√ó1.5)</option>
                        <option value="liga_grupos">Liga - Fase de Grupos (√ó2.0)</option>
                        <option value="liga_finales">Liga - Playoffs (√ó2.5)</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 16px;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="color: #d4af37; margin-bottom: 8px; display: block;">Puntos Ganador:</label>
                    <input type="number" id="winnerScore" value="3" min="1" max="3" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff;">
                </div>
                
                <div style="flex: 1; min-width: 200px;">
                    <label style="color: #d4af37; margin-bottom: 8px; display: block;">Puntos Perdedor:</label>
                    <input type="number" id="loserScore" value="0" min="0" max="2" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff;">
                </div>
            </div>
            
            <div id="adminMatchPreview" style="background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; padding: 12px; margin-top: 16px; display: none;">
                <div style="color: #d4af37; font-weight: bold; margin-bottom: 8px;">üìä Previsualizaci√≥n ELO:</div>
                <div id="adminMatchPreviewContent"></div>
            </div>
            
            <button class="btn" onclick="addAdminMatch()" data-i18n="admin_add_match_btn">‚ûï A√±adir Partido</button>
            <div id="adminMatchStatus"></div>
        </div>

        <div class="section">
            <div class="section-title" data-i18n="admin_view_ranking">üìä Ver Ranking Actual</div>
            
            <div class="period-select">
                <label for="periodType" data-i18n="admin_select_period">Seleccionar per√≠odo:</label>
                <select id="periodType" onchange="loadCurrentLeaderboard()">
                    <option value="daily" data-i18n="admin_period_today">Hoy</option>
                    <option value="weekly" data-i18n="admin_period_this_week">Esta Semana</option>
                    <option value="monthly" selected data-i18n="admin_period_this_month">Este Mes</option>
                    <option value="quarterly" data-i18n="admin_period_this_quarter">Este Trimestre</option>
                    <option value="yearly" data-i18n="admin_period_this_year">Este A√±o</option>
                </select>
            </div>
            
            <div id="leaderboardContainer">
                <div class="loading" data-i18n="admin_select_period_loading">Selecciona un per√≠odo para ver el ranking</div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- App Scripts -->
    <script src="../js/translations.js"></script>
    <script src="../js/firebase.js"></script>
    <script src="../js/badges.js"></script>

    <script>
        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (typeof firebase !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(() => waitForFirebase().then(resolve), 100);
                }
            });
        }

        // Award champions for a specific period
        async function awardChampions(periodType) {
            const statusDiv = document.getElementById('awardStatus');
            statusDiv.innerHTML = `<div class="status info">${t('loading')}</div>`;
            
            try {
                const result = await awardChampionBadges(periodType);
                
                if (!result) {
                    statusDiv.innerHTML = `<div class="status error">${t('admin_no_data')}</div>`;
                    return;
                }
                
                const championNames = result.champions.map(c => c.username).join(', ');
                let message = `${championNames} (${result.maxWins} ${t('admin_wins_suffix')})`;
                
                statusDiv.innerHTML = `<div class="status success">‚úÖ ${message}</div>`;
                
            } catch (error) {
                console.error('Error awarding champions:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå ${t('toast_error_title')}: ${error.message}</div>`;
            }
        }

        // Load current leaderboard
        async function loadCurrentLeaderboard() {
            const periodType = document.getElementById('periodType').value;
            const container = document.getElementById('leaderboardContainer');
            
            container.innerHTML = `<div class="loading">${t('loading')}...</div>`;
            
            try {
                const { leaders, periodKey } = await getCurrentLeaderboard(periodType);
                
                if (leaders.length === 0) {
                    container.innerHTML = `<div class="loading">${t('admin_no_data')}</div>`;
                    return;
                }
                
                // Find max wins to identify champion(s)
                const maxWins = Math.max(...leaders.map(l => l.wins));
                
                const html = `
                    <div style="margin-bottom: 16px; color: #aaa;">
                        Period: <strong style="color: #d4af37;">${periodKey}</strong>
                    </div>
                    ${leaders.map((leader, index) => `
                        <div class="leaderboard-item ${leader.wins === maxWins ? 'champion' : ''}">
                            <div class="player-info">
                                <span class="rank">#${index + 1}</span>
                                <span>${leader.username}</span>
                                ${leader.wins === maxWins ? '<span style="color: #d4af37;">üëë</span>' : ''}
                            </div>
                            <span class="wins">${leader.wins} ${t('admin_wins_suffix')}</span>
                        </div>
                    `).join('')}
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                container.innerHTML = `<div class="status error">${t('toast_error_title')}: ${error.message}</div>`;
            }
        }

        // Initialize
        waitForFirebase().then(async () => {
            document.getElementById('langSelectorContainer').innerHTML = createLanguageSelector();
            initFirebase();
            loadCurrentLeaderboard();
            
            // Load users for manual match addition
            loadAdminMatchUsers();
        });

        // Load users for manual match
        async function loadAdminMatchUsers() {
            try {
                const usersSnap = await database.ref('users').once('value');
                const users = usersSnap.val();
                
                if (!users) return;
                
                const player1Select = document.getElementById('player1');
                const player2Select = document.getElementById('player2');
                const winnerSelect = document.getElementById('winner');
                
                // Sort by username
                const sortedUsers = Object.entries(users).map(([uid, user]) => ({
                    uid,
                    ...user
                })).sort((a, b) => a.username.localeCompare(b.username));
                
                sortedUsers.forEach(user => {
                    const option1 = document.createElement('option');
                    option1.value = user.uid;
                    option1.textContent = user.username;
                    player1Select.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = user.uid;
                    option2.textContent = user.username;
                    player2Select.appendChild(option2);
                    
                    const optionWinner = document.createElement('option');
                    optionWinner.value = user.uid;
                    optionWinner.textContent = user.username;
                    winnerSelect.appendChild(optionWinner);
                });
                
                // Add event listeners for preview
                [player1Select, player2Select, winnerSelect].forEach(select => {
                    select.addEventListener('change', updateAdminMatchPreview);
                });
                
                document.getElementById('matchType').addEventListener('change', updateAdminMatchPreview);
                document.getElementById('winnerScore').addEventListener('change', updateAdminMatchPreview);
                document.getElementById('loserScore').addEventListener('change', updateAdminMatchPreview);
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Update match preview
        async function updateAdminMatchPreview() {
            const player1Id = document.getElementById('player1').value;
            const player2Id = document.getElementById('player2').value;
            const winnerId = document.getElementById('winner').value;
            const matchType = document.getElementById('matchType').value;
            const winnerScore = parseInt(document.getElementById('winnerScore').value) || 3;
            const loserScore = parseInt(document.getElementById('loserScore').value) || 0;
            
            if (!player1Id || !player2Id || !winnerId) {
                document.getElementById('adminMatchPreview').style.display = 'none';
                return;
            }
            
            if (player1Id === player2Id) {
                return; // Same player
            }
            
            try {
                const usersSnap = await database.ref('users').once('value');
                const users = usersSnap.val();
                
                const player1 = users[player1Id];
                const player2 = users[player2Id];
                const winner = users[winnerId];
                const loser = winnerId === player1Id ? player2 : player1;
                
                if (!player1 || !player2 || !winner) {
                    return;
                }
                
                const winnerElo = winner.elo_rating || 1200;
                const loserElo = loser.elo_rating || 1200;
                const winnerMatches = winner.matches_played || 0;
                const loserMatches = loser.matches_played || 0;
                
                // Calculate ELO changes
                const changes = calculateMatchEloChange(winnerElo, loserElo, winnerMatches, loserMatches, matchType);
                
                const player1Change = winnerId === player1Id ? changes.winnerChange : changes.loserChange;
                const player2Change = winnerId === player2Id ? changes.winnerChange : changes.loserChange;
                const player1NewElo = winnerId === player1Id ? changes.winnerElo : changes.loserElo;
                const player2NewElo = winnerId === player2Id ? changes.winnerElo : changes.loserElo;
                
                document.getElementById('adminMatchPreview').style.display = 'block';
                document.getElementById('adminMatchPreviewContent').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${player1.username}:</strong> ${player1Elo} ‚Üí ${player1NewElo} (${player1Change >= 0 ? '+' : ''}${player1Change})
                        </div>
                        <div style="color: #aaa;">vs</div>
                        <div>
                            <strong>${player2.username}:</strong> ${player2Elo} ‚Üí ${player2NewElo} (${player2Change >= 0 ? '+' : ''}${player2Change})
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error updating preview:', error);
            }
        }

        // Add admin match
        async function addAdminMatch() {
            const player1Id = document.getElementById('player1').value;
            const player2Id = document.getElementById('player2').value;
            const winnerId = document.getElementById('winner').value;
            const matchType = document.getElementById('matchType').value;
            const winnerScore = parseInt(document.getElementById('winnerScore').value) || 3;
            const loserScore = parseInt(document.getElementById('loserScore').value) || 0;
            const statusDiv = document.getElementById('adminMatchStatus');
            
            // Validation
            if (!player1Id || !player2Id || !winnerId) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Selecciona ambos jugadores y ganador</div>`;
                return;
            }
            
            if (player1Id === player2Id) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Los jugadores deben ser diferentes</div>`;
                return;
            }
            
            statusDiv.innerHTML = `<div class="status info">‚è≥ A√±adiendo partido...</div>`;
            
            try {
                const usersSnap = await database.ref('users').once('value');
                const users = usersSnap.val();
                
                const player1 = users[player1Id];
                const player2 = users[player2Id];
                const winner = users[winnerId];
                const loser = winnerId === player1Id ? player2 : player1;
                
                const winnerElo = winner.elo_rating || 1200;
                const loserElo = loser.elo_rating || 1200;
                const winnerMatches = winner.matches_played || 0;
                const loserMatches = loser.matches_played || 0;
                
                // Calculate ELO changes
                const changes = calculateMatchEloChange(winnerElo, loserElo, winnerMatches, loserMatches, matchType);
                
                // Create match data
                const matchData = {
                    player1_id: player1Id,
                    player1_username: player1.username,
                    player2_id: player2Id,
                    player2_username: player2.username,
                    winner_id: winnerId,
                    match_type: matchType,
                    status: 'confirmed',
                    confirmed_at: Date.now(),
                    confirmed_hour: new Date().getHours(),
                    confirmed_minute: new Date().getMinutes(),
                    confirmed_day_of_week: new Date().getDay(),
                    is_weekend: new Date().getDay() === 0 || new Date().getDay() === 6,
                    player1_score: winnerId === player1Id ? winnerScore : loserScore,
                    player2_score: winnerId === player2Id ? winnerScore : loserScore,
                    winner_score: winnerScore,
                    loser_score: loserScore,
                    winner_elo_change: changes.winnerChange,
                    loser_elo_change: changes.loserChange,
                    winner_new_elo: changes.winnerElo,
                    loser_new_elo: changes.loserElo,
                    created_at: Date.now(),
                    submitted_by: 'admin',
                    submitted_at: Date.now()
                };
                
                // Save match to Firebase
                const matchRef = await database.ref('matches').push(matchData);
                
                // Update both players' stats
                await database.ref(`users/${winnerId}/elo_rating`).set(changes.winnerElo);
                await database.ref(`users/${loserId}/elo_rating`).set(changes.looserElo);
                
                // Update matches played
                await database.ref(`users/${winnerId}/matches_played`).set(winnerMatches + 1);
                await database.ref(`users/${loserId}/matches_played`).set(loserMatches + 1);
                
                // Update matches won for winner
                await database.ref(`users/${winnerId}/matches_won`).set((winner.matches_won || 0) + 1);
                
                // Add admin note
                const adminMatchNote = {
                    added_by_admin: true,
                    added_at: Date.now(),
                    admin_note: 'Manual admin match'
                };
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ Partido a√±adido: ${player1.username} vs ${player2.username}
                        <br>Resultado: ${winnerScore}-${loserScore}, Ganador: ${winner.username}
                        <br>${winner.username}: ${winnerElo} ‚Üí ${changes.winnerElo} (${changes.winnerChange >= 0 ? '+' : ''}${changes.winnerChange})
                        <br>${loser.username}: ${loserElo} ‚Üí ${changes.loserElo} (${changes.loserChange >= 0 ? '+' : ''}${changes.loserChange})
                    </div>
                `;
                
                // Reset form
                document.getElementById('player1').selectedIndex = 0;
                document.getElementById('player2').selectedIndex = 0;
                document.getElementById('winner').selectedIndex = 0;
                document.getElementById('adminMatchPreview').style.display = 'none';
                
            } catch (error) {
                console.error('Error adding admin match:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
