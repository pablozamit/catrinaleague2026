<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introducir Resultado - La Catrina</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="../js/elo.js"></script>
    <style>
        :root {
            --color-bg: #0a0a0a;
            --color-felt: #1a4a2e;
            --color-gold: #d4af37;
            --color-gold-light: #f4d03f;
            --color-white: #f5f5f5;
            --color-text-muted: #888;
            --color-success: #4ade80;
            --color-danger: #f87171;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--color-bg);
            min-height: 100vh;
            color: var(--color-white);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 50%);
        }

        .header {
            background: linear-gradient(180deg, rgba(26, 74, 46, 0.3) 0%, transparent 100%);
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 900;
            color: var(--color-gold);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            letter-spacing: 4px;
            margin-bottom: 0.5rem;
        }

        .user-info {
            color: var(--color-white);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .back-link {
            position: absolute;
            top: 2rem;
            left: 2rem;
            color: var(--color-gold);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-right {
            position: absolute;
            top: 2rem;
            right: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-gold);
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--color-white);
            font-size: 1rem;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--color-gold);
        }

        .form-group select option {
            background: #1a1a1a;
        }

        .player-fixed {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid var(--color-gold);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .player-fixed .label {
            color: var(--color-gold);
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
        }

        .player-fixed .username {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-white);
        }

        .player-fixed .elo {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-top: 0.3rem;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-gold) 0%, #b8962e 100%);
            color: var(--color-bg);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            margin-top: 1rem;
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
        }

        .error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--color-success);
            color: var(--color-success);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .preview {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .preview h4 {
            color: var(--color-gold);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .preview-row {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
        }

        .preview-row .positive { color: var(--color-success); }
        .preview-row .negative { color: var(--color-danger); }

        .match-type-info {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 0.3rem;
        }

        .hidden { display: none; }

        .result-selector {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .result-option {
            flex: 1;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .result-option:hover { border-color: var(--color-gold); }
        .result-option.selected {
            border-color: var(--color-gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .result-option .player-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .result-option .score {
            font-size: 1.5rem;
            font-family: 'Cinzel', serif;
            color: var(--color-gold);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../" class="back-link" data-i18n="back">‚Üê Volver</a>
        <div class="header-right">
            <div id="langSelectorContainer" style="margin-right: 15px;"></div>
            <div id="notificationBellContainer"></div>
            <button class="logout-btn" onclick="showChangePasswordModal()" style="margin-right: 10px;" data-i18n="change_password">Cambiar Contrase√±a</button>
            <button class="logout-btn" onclick="logout()" data-i18n="logout">Cerrar Sesi√≥n</button>
        </div>
        <h1 data-i18n="results_title">INTRODUCIR RESULTADO</h1>
        <div class="user-info"><span data-i18n="results_user">Usuario</span>: <span id="currentUsername">-</span></div>
    </div>

    <div class="container">
        <!-- Loading -->
        <div id="loadingScreen" class="card">
            <div class="loading" data-i18n="loading">Cargando...</div>
        </div>

        <!-- Formulario -->
        <div id="resultScreen" class="card hidden">
            <div id="resultSuccess" class="success" data-i18n="results_success">¬°Resultado enviado! Esperando confirmaci√≥n del oponente.</div>
            <div id="resultError" class="error"></div>

            <!-- Jugador logueado (fijo) -->
            <div class="player-fixed">
                <div class="label" data-i18n="results_you">T√ö</div>
                <div class="username" id="myUsername">-</div>
                <div class="elo"><span data-i18n="results_opponent_elo">ELO</span>: <span id="myElo">-</span></div>
            </div>

            <!-- Oponente -->
            <div class="form-group">
                <label data-i18n="results_opponent">Contrincante</label>
                <select id="opponent" onchange="updatePreview()">
                    <option value="" data-i18n="results_select_opponent">Seleccionar oponente...</option>
                </select>
            </div>

            <!-- Tipo de partido -->
            <div class="form-group">
                <label data-i18n="results_match_type">Tipo de Partido</label>
                <select id="matchType" onchange="updatePreview()">
                    <option value="rey_mesa" data-i18n="match_type_rey_mesa_full">Rey de la Mesa (√ó1.0)</option>
                    <option value="torneo" data-i18n="match_type_torneo_full">Torneo (√ó1.5)</option>
                    <option value="liga_grupos" data-i18n="match_type_liga_grupos_full">Liga - Fase de Grupos (√ó2.0)</option>
                    <option value="liga_finales" data-i18n="match_type_liga_finales_full">Liga - Playoffs (√ó2.5)</option>
                </select>
                <div class="match-type-info" data-i18n="results_match_type_info">√ó1.0 (base) √ó2.5 (m√°ximo para finales)</div>
            </div>

            <!-- Resultado -->
            <div class="form-group">
                <label data-i18n="results_result">Resultado</label>
                <div class="result-selector">
                    <div class="result-option" id="resultMe" onclick="selectWinner('me')">
                        <div class="player-name" id="winnerMeName" data-i18n="results_you_win">Yo</div>
                        <div class="score" data-i18n="results_wins">GANA</div>
                    </div>
                    <div class="result-option" id="resultOpponent" onclick="selectWinner('opponent')">
                        <div class="player-name" id="winnerOpponentName" data-i18n="results_opponent_win">Oponente</div>
                        <div class="score" data-i18n="results_wins">GANA</div>
                    </div>
                </div>
            </div>

            <!-- Score / Marcador -->
            <div class="form-group" id="scoreGroup" style="display: none;">
                <label data-i18n="results_final_score">Marcador Final</label>
                <div class="score-inputs" style="display: flex; gap: 10px; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;" data-i18n="results_winner">Ganador</div>
                        <select id="winnerScore" onchange="updatePreview()" style="padding: 10px; font-size: 16px; min-width: 60px; text-align: center; background: rgba(212, 175, 55, 0.1); border: 2px solid #d4af37; color: #d4af37; border-radius: 8px;">
                            <option value="3" selected>3</option>
                        </select>
                    </div>
                    <div style="font-size: 24px; color: #666;">-</div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;" data-i18n="results_loser">Perdedor</div>
                        <select id="loserScore" onchange="updatePreview()" style="padding: 10px; font-size: 16px; min-width: 60px; text-align: center; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); color: #fff; border-radius: 8px;">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                        </select>
                    </div>
                </div>
                <div class="match-type-info" id="scoreInfo" style="margin-top: 10px; font-size: 13px;"></div>
            </div>

            <!-- Preview ELO -->
            <div id="eloPreview" class="preview hidden">
                <h4 data-i18n="results_elo_preview">üìä Previsualizaci√≥n del cambio ELO</h4>
                <div class="preview-row">
                    <span id="previewMyName">Yo</span>
                    <span><span id="previewMyChange">+0</span> ‚Üí <strong id="previewMyNewElo">0</strong></span>
                </div>
                <div class="preview-row">
                    <span id="previewOpponentName">Oponente</span>
                    <span><span id="previewOpponentChange">+0</span> ‚Üí <strong id="previewOpponentNewElo">0</strong></span>
                </div>
            </div>

            <button class="btn btn-primary" id="submitBtn" onclick="submitResult()" disabled data-i18n="results_submit">
                Enviar Resultado
            </button>
        </div>
    </div>

    <div class="footer">
        <p data-i18n="app_name">La Catrina Pool League</p>
    </div>

    <!-- Modal Cambiar Contrase√±a -->
    <div id="changePasswordModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #d4af37; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%;">
            <h3 style="color: #d4af37; margin: 0 0 20px 0; text-align: center;" data-i18n="password_change_title">Cambiar Contrase√±a</h3>
            
            <div id="changePasswordError" class="error" style="display: none; margin-bottom: 15px;"></div>
            <div id="changePasswordSuccess" class="success" style="display: none; margin-bottom: 15px;" data-i18n="password_change_success">¬°Contrase√±a actualizada correctamente!</div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: #d4af37;" data-i18n="password_current">Contrase√±a Actual</label>
                <input type="password" id="currentPassword" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff; font-size: 16px;" data-i18n="password_current_placeholder" placeholder="Tu contrase√±a actual">
            </div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: #d4af37;" data-i18n="password_new">Nueva Contrase√±a</label>
                <input type="password" id="newPassword" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff; font-size: 16px;" data-i18n="password_new_placeholder" placeholder="M√≠nimo 6 caracteres">
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #d4af37;" data-i18n="password_confirm">Confirmar Nueva Contrase√±a</label>
                <input type="password" id="confirmNewPassword" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: #fff; font-size: 16px;" data-i18n="password_confirm_placeholder" placeholder="Repite la nueva contrase√±a">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closeChangePasswordModal()" style="flex: 1; padding: 12px; background: transparent; border: 1px solid #d4af37; color: #d4af37; border-radius: 8px; cursor: pointer;" data-i18n="password_cancel">Cancelar</button>
                <button onclick="changePassword()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); border: none; color: #000; border-radius: 8px; cursor: pointer; font-weight: bold;" data-i18n="password_change_button">Cambiar</button>
            </div>
        </div>
    </div>

    <script src="../js/firebase.js"></script>
    <script src="../js/badges.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/toast.js"></script>
    <script>
        // Variables globales
        let currentUserData = null;
        let allUsers = [];
        let selectedWinner = null;

        async function waitForFirebase() {
            let attempts = 0;
            while (!window.firebase && attempts < 20) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            return !!window.firebase;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            const ready = await waitForFirebase();
            if (!ready) {
                document.getElementById('loadingScreen').innerHTML = '<div class="error" style="display:block">Error cargando Firebase</div>';
                return;
            }
            
            initFirebase();

            onAuthStateChanged((user) => {
                if (!user) {
                    // No hay sesi√≥n, redirigir a login
                    window.location.href = '../';
                } else {
                    loadUserData(user);
                }
            });
        });

        async function loadUserData(user) {
            try {
                currentUser = user;
                
                // Obtener datos del usuario desde Firebase
                const userData = await getUserData(user.uid);
                
                if (!userData) {
                    // Usuario no encontrado, crear entrada
                    const username = user.email.split('@')[0];
                    currentUserData = {
                        username: username,
                        elo_rating: 1200,
                        matches_played: 0,
                        matches_won: 0,
                        email: user.email
                    };
                    await updateUserElo(user.uid, 1200, 0, 0);
                } else {
                    currentUserData = userData;
                }

                // Actualizar UI
                document.getElementById('currentUsername').textContent = currentUserData.username;
                document.getElementById('myUsername').textContent = currentUserData.username;
                document.getElementById('myElo').textContent = currentUserData.elo_rating;

                // Cargar todos los usuarios
                await loadAllUsers();
                
                // Inicializar notificaciones
                const bellContainer = document.getElementById('notificationBellContainer');
                bellContainer.innerHTML = createNotificationBell();
                await updateNotificationBell(user.uid);
                
                // Mostrar formulario
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('resultScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="error" style="display:block">
                        Error al cargar datos: ${error.message}
                    </div>
                `;
            }
        }

        async function loadAllUsers() {
            try {
                allUsers = await getAllUsers();
                
                const opponentSelect = document.getElementById('opponent');
                opponentSelect.innerHTML = '<option value="">Seleccionar oponente...</option>';
                
                // Filtrar el usuario actual
                const otherUsers = allUsers.filter(u => u.uid !== currentUser.uid);
                
                otherUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.uid;
                    option.textContent = `${user.username} (ELO: ${user.elo_rating || 1200})`;
                    opponentSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function selectWinner(winner) {
            selectedWinner = winner;
            document.querySelectorAll('.result-option').forEach(el => el.classList.remove('selected'));
            
            if (winner === 'me') {
                document.getElementById('resultMe').classList.add('selected');
            } else {
                document.getElementById('resultOpponent').classList.add('selected');
            }
            
            // Show score inputs
            document.getElementById('scoreGroup').style.display = 'block';
            
            updatePreview();
        }

        function updatePreview() {
            const opponentUid = document.getElementById('opponent').value;
            const matchType = document.getElementById('matchType').value;

            if (!opponentUid || !selectedWinner) {
                document.getElementById('eloPreview').classList.add('hidden');
                document.getElementById('submitBtn').disabled = true;
                return;
            }

            const opponent = allUsers.find(u => u.uid === opponentUid);
            if (!opponent) return;

            const myElo = currentUserData.elo_rating || 1200;
            const opponentElo = opponent.elo_rating || 1200;
            const myMatches = currentUserData.matches_played || 0;
            const opponentMatches = opponent.matches_played || 0;

            // Actualizar nombres
            document.getElementById('winnerMeName').textContent = currentUserData.username;
            document.getElementById('winnerOpponentName').textContent = opponent.username;
            document.getElementById('previewMyName').textContent = currentUserData.username;
            document.getElementById('previewOpponentName').textContent = opponent.username;

            // Calcular cambio ELO
            const winner = selectedWinner === 'me' ? currentUserData : opponent;
            const loser = selectedWinner === 'me' ? opponent : currentUserData;
            
            const winnerElo = selectedWinner === 'me' ? myElo : opponentElo;
            const loserElo = selectedWinner === 'me' ? opponentElo : myElo;
            const winnerMatches = selectedWinner === 'me' ? myMatches : opponentMatches;
            const loserMatches = selectedWinner === 'me' ? opponentMatches : myMatches;

            const changes = calculateEloChange(winnerElo, loserElo, winnerMatches, loserMatches, matchType);

            const myChange = selectedWinner === 'me' ? changes.winnerChange : changes.loserChange;
            const opponentChange = selectedWinner === 'me' ? changes.loserChange : changes.winnerChange;
            const myNewElo = selectedWinner === 'me' ? changes.winnerElo : changes.loserElo;
            const opponentNewElo = selectedWinner === 'me' ? changes.loserElo : changes.winnerElo;

            const myEl = document.getElementById('previewMyChange');
            const opponentEl = document.getElementById('previewOpponentChange');

            myEl.textContent = (myChange >= 0 ? '+' : '') + myChange;
            myEl.className = myChange >= 0 ? 'positive' : 'negative';

            opponentEl.textContent = (opponentChange >= 0 ? '+' : '') + opponentChange;
            opponentEl.className = opponentChange >= 0 ? 'positive' : 'negative';

            // Mostrar nuevo ELO
            document.getElementById('previewMyNewElo').textContent = myNewElo;
            document.getElementById('previewOpponentNewElo').textContent = opponentNewElo;

            document.getElementById('eloPreview').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = false;
        }

        // Rate limiting for submissions
        let lastSubmissionTime = 0;
        const SUBMISSION_COOLDOWN = 5000; // 5 seconds between submissions

        async function submitResult() {
            try {
                // Rate limiting check
                const now = Date.now();
                if (now - lastSubmissionTime < SUBMISSION_COOLDOWN) {
                    showError('Por favor espera unos segundos antes de enviar otro resultado');
                    return;
                }

                const opponentUid = document.getElementById('opponent').value;
                const matchType = document.getElementById('matchType').value;

                // Validation
                if (!opponentUid) {
                    showError('Por favor selecciona un oponente');
                    return;
                }

                if (!selectedWinner) {
                    showError('Por favor selecciona qui√©n gan√≥ el partido');
                    return;
                }

                if (!matchType) {
                    showError('Por favor selecciona el tipo de partido');
                    return;
                }

                // Validate match type is valid
                const validMatchTypes = ['rey_mesa', 'torneo', 'liga_grupos', 'liga_finales'];
                if (!validMatchTypes.includes(matchType)) {
                    showError('Tipo de partido inv√°lido');
                    return;
                }

                const opponent = allUsers.find(u => u.uid === opponentUid);
                
                if (!opponent) {
                    showError('Oponente no encontrado');
                    return;
                }

                // Security: Prevent playing against yourself
                if (opponent.uid === currentUser.uid) {
                    showError('No puedes jugar contra ti mismo');
                    return;
                }

                // Validate usernames (prevent injection)
                const usernamePattern = /^[a-zA-Z0-9_-]+$/;
                if (!usernamePattern.test(currentUserData.username) || !usernamePattern.test(opponent.username)) {
                    showError('Nombre de usuario inv√°lido');
                    return;
                }

                // Sanitize usernames
                const sanitizeUsername = (name) => name.replace(/[<>"'&]/g, '');

                // Get scores
                const winnerScore = parseInt(document.getElementById('winnerScore').value);
                const loserScore = parseInt(document.getElementById('loserScore').value);

                const matchData = {
                    player1_id: currentUser.uid,
                    player1_username: sanitizeUsername(currentUserData.username),
                    player2_id: opponent.uid,
                    player2_username: sanitizeUsername(opponent.username),
                    winner_id: selectedWinner === 'me' ? currentUser.uid : opponent.uid,
                    match_type: matchType,
                    submitted_by: currentUser.uid,
                    submitted_at: Date.now(),
                    player1_score: selectedWinner === 'me' ? winnerScore : loserScore,
                    player2_score: selectedWinner === 'me' ? loserScore : winnerScore,
                    winner_score: winnerScore,
                    loser_score: loserScore
                };

                lastSubmissionTime = now;
                await createMatch(matchData);
                
                // Mostrar toast de √©xito
                if (typeof CatrinaToast !== 'undefined') {
                    const winnerName = selectedWinner === 'me' ? currentUserData.username : opponent.username;
                    CatrinaToast.success(
                        `Resultado enviado correctamente. Esperando confirmaci√≥n de ${opponent.username}.`,
                        '¬°Partido Registrado!',
                        { duration: 5000 }
                    );
                }
                
                // Reset form
                setTimeout(() => {
                    document.getElementById('opponent').selectedIndex = 0;
                    document.getElementById('matchType').selectedIndex = 0;
                    selectedWinner = null;
                    document.querySelectorAll('.result-option').forEach(el => el.classList.remove('selected'));
                    document.getElementById('eloPreview').classList.add('hidden');
                    document.getElementById('submitBtn').disabled = true;
                }, 3000);
                
            } catch (error) {
                console.error('Error submitting result:', error);
                // Mostrar toast de error
                if (typeof CatrinaToast !== 'undefined') {
                    CatrinaToast.error(
                        'No se pudo enviar el resultado. Por favor intenta de nuevo.',
                        'Error al Enviar'
                    );
                } else {
                    // Fallback a mensaje tradicional
                    showError('Error al enviar resultado. Por favor intenta de nuevo.');
                }
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('resultError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            // Tambi√©n mostrar como toast si est√° disponible
            if (typeof CatrinaToast !== 'undefined') {
                CatrinaToast.error(message, 'Error');
            }
        }

        // Cambiar Contrase√±a Functions
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('changePasswordError').style.display = 'none';
            document.getElementById('changePasswordSuccess').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const errorEl = document.getElementById('changePasswordError');
            const successEl = document.getElementById('changePasswordSuccess');

            // Validaciones
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                errorEl.textContent = typeof t !== 'undefined' ? t('password_error_all_fields') : 'Por favor completa todos los campos';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (newPassword.length < 6) {
                errorEl.textContent = typeof t !== 'undefined' ? t('error_password_min_length') : 'La nueva contrase√±a debe tener al menos 6 caracteres';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (newPassword !== confirmNewPassword) {
                errorEl.textContent = typeof t !== 'undefined' ? t('password_error_no_match') : 'Las contrase√±as nuevas no coinciden';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            if (newPassword === currentPassword) {
                errorEl.textContent = typeof t !== 'undefined' ? t('password_error_different') : 'La nueva contrase√±a debe ser diferente a la actual';
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                return;
            }

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('No hay usuario autenticado');
                }

                // Re-autenticar usuario con contrase√±a actual
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPassword
                );
                await user.reauthenticateWithCredential(credential);

                // Cambiar contrase√±a
                await user.updatePassword(newPassword);

                // Mostrar √©xito
                successEl.style.display = 'block';
                errorEl.style.display = 'none';

                // Limpiar campos
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';

                // Cerrar modal despu√©s de 2 segundos
                setTimeout(() => {
                    closeChangePasswordModal();
                }, 2000);

                // Mostrar toast
                if (typeof CatrinaToast !== 'undefined') {
                    CatrinaToast.success('Tu contrase√±a ha sido actualizada correctamente', 'Contrase√±a Cambiada');
                }

            } catch (error) {
                console.error('Error changing password:', error);
                
                let errorMessage = typeof t !== 'undefined' ? t('password_change_error') : 'Error al cambiar la contrase√±a';
                
                if (error.code === 'auth/wrong-password') {
                    errorMessage = typeof t !== 'undefined' ? t('password_error_current_wrong') : 'La contrase√±a actual es incorrecta';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = typeof t !== 'undefined' ? t('password_error_weak') : 'La nueva contrase√±a es demasiado d√©bil';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = typeof t !== 'undefined' ? t('password_error_relogin_required') : 'Por seguridad, debes cerrar sesi√≥n y volver a iniciar sesi√≥n antes de cambiar la contrase√±a';
                }

                errorEl.textContent = errorMessage;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            }
        }

        // Cerrar modal al hacer click fuera
        document.getElementById('changePasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChangePasswordModal();
            }
        });

        async function logout() {
            await signOut();
            window.location.href = '../';
        }
    </script>
    <script src="../js/translations.js"></script>
    <script>
        document.getElementById('langSelectorContainer').innerHTML = createLanguageSelector();
    </script>
</body>
</html>
